# 次のステップ - 具体的な手順書

このドキュメントでは、プロジェクトの動作確認から本番運用までの具体的な手順を記載します。

## 📋 目次

1. [動作環境の準備](#ステップ-1-動作環境の準備)
2. [初回動作確認](#ステップ-2-初回動作確認)
3. [段階的な動作テスト](#ステップ-3-段階的な動作テスト)
4. [セレクタの調整方法](#ステップ-4-セレクタの調整方法)
5. [本番環境での動作確認](#ステップ-5-本番環境での動作確認)
6. [問題発生時のトラブルシューティング](#ステップ-6-問題発生時のトラブルシューティング)
7. [パフォーマンス調整](#ステップ-7-パフォーマンス調整)
8. [本番運用の準備](#ステップ-8-本番運用の準備)

---

## ステップ 1: 動作環境の準備

### 1.1 必要なソフトウェアの確認

```bash
# Java 17以上がインストールされているか確認
java -version

# Mavenがインストールされているか確認
mvn -version

# Chromeブラウザがインストールされているか確認
# （ChromeDriverは自動でダウンロードされます）
```

### 1.2 設定ファイルの確認

`src/main/resources/application.properties` を開き、以下を確認：

- ✅ 監視対象 URL が正しく設定されているか
- ✅ ログイン情報（username, password）が正しいか
- ✅ 予約情報（name, email）が正しいか
- ✅ 対象時間（target.time）が "20:25" になっているか
- ✅ 監視間隔（monitoring.interval.seconds）が適切か（デフォルト: 5 秒）
- ✅ ヘッドレスモード（headless）の設定（テスト時は `false` 推奨）

---

## ステップ 2: 初回動作確認

### 2.1 GUI アプリケーションの起動

```bash
# プロジェクトディレクトリに移動
cd jicoo-reservation-bot

# GUIアプリケーションを起動
mvn exec:java
```

または

```bash
# JARファイルから起動
java -jar target/jicoo-reservation-bot-1.0.0.jar
```

### 2.2 動作確認チェックリスト

GUI が起動したら、以下を確認：

- [ ] GUI ウィンドウが表示される
- [ ] 「開始」ボタンがクリック可能
- [ ] ログエリアが表示される
- [ ] ステータス表示が「状態: 待機中」になっている

---

## ステップ 3: 段階的な動作テスト

### テスト 1: WebDriver の初期化確認

**手順：**

1. GUI アプリケーションで「開始」ボタンをクリック
2. ログエリアで以下を確認：
   - `WebDriverを初期化しています...` が表示される
   - Chrome ブラウザが起動する（headless=false の場合）
   - `WebDriverの初期化が完了しました` が表示される

**問題が発生した場合：**

- ChromeDriver のダウンロードに失敗している可能性
- **解決策**: インターネット接続を確認、WebDriverManager が自動でダウンロードします

### テスト 2: URL アクセス確認

**手順：**

1. ログエリアで以下を確認：
   - `URL処理開始: https://www.jicoo.com/...` が表示される
   - `ページにアクセスしました` が表示される
   - Chrome ブラウザでページが表示される

**問題が発生した場合：**

- URL が間違っている、またはページが読み込めない
- **解決策**: `application.properties` の URL を確認

### テスト 3: ログインポップアップ確認

**手順：**

1. ログエリアで以下を確認：
   - `ログインポップアップの存在を確認しています...` が表示される
   - ポップアップが表示された場合：
     - `ログインポップアップを検出しました` が表示される
     - ユーザー名・パスワードが自動入力される
     - `ログイン処理が完了しました` が表示される
   - ポップアップが表示されない場合：
     - `ログインポップアップは存在しません` が表示される

**問題が発生した場合：**

- ログインポップアップのセレクタが合っていない
- **解決策**: [セレクタの調整方法](#ステップ-4-セレクタの調整方法) を参照

### テスト 4: カレンダー日付選択確認

**手順：**

1. ログエリアで以下を確認：
   - `日付を選択します: 2025-XX-XX` が表示される（今日から 7 日後）
   - カレンダーで該当日がクリックされる
   - `日付をクリックしました` が表示される

**問題が発生した場合：**

- カレンダーのセレクタが合っていない
- **解決策**: [セレクタの調整方法](#ステップ-4-セレクタの調整方法) を参照

### テスト 5: タイムスロット監視確認

**手順：**

1. ログエリアで以下を確認：
   - `タイムスロットを監視します: 20:25` が表示される
   - `ページを更新しました` が定期的に表示される（5 秒間隔）
   - タイムスロットボタンが見つからない場合：
     - `タイムスロットボタンが見つかりません` が表示される

**問題が発生した場合：**

- タイムスロットのセレクタが合っていない
- **解決策**: [セレクタの調整方法](#ステップ-4-セレクタの調整方法) を参照

---

## ステップ 4: セレクタの調整方法

### 4.1 ブラウザの開発者ツールで要素を確認

1. Chrome ブラウザで対象ページを開く
2. `F12` キーで開発者ツールを開く
3. `Elements` タブで要素を確認
4. 対象要素を右クリック → `Copy` → `Copy XPath` または `Copy selector`

### 4.2 セレクタをコードに反映

`ReservationService.java` の該当メソッドで、セレクタ配列に追加：

```java
// 例: ログインポップアップのセレクタを追加
String[] selectors = {
    "//input[@type='text']",           // 既存
    "//input[@id='username']",         // 新規追加
    "//input[@name='user']"            // 新規追加
};
```

### 4.3 調整が必要な可能性がある箇所

| 機能                 | ファイル                | メソッド              | セレクタの場所   |
| -------------------- | ----------------------- | --------------------- | ---------------- |
| ログインポップアップ | ReservationService.java | handleLoginPopup()    | 100-120 行目付近 |
| カレンダー日付選択   | ReservationService.java | selectDate()          | 150-210 行目付近 |
| タイムスロット監視   | ReservationService.java | monitorTimeSlot()     | 235-240 行目付近 |
| 予約フォーム入力     | ReservationService.java | fillReservationForm() | 325-360 行目付近 |
| 予約確定             | ReservationService.java | submitReservation()   | 404-409 行目付近 |

---

## ステップ 5: 本番環境での動作確認

### 5.1 実際の予約時間でのテスト

**テスト実行前の準備：**

- 予約が解放される時間を確認（例: 毎日 20:00 に 1 週間後の予約が解放）
- テスト実行時刻を設定（例: 19:55 に起動）

**実行手順：**

```bash
# GUIアプリケーションを起動
mvn exec:java

# 「開始」ボタンをクリック
# ログを監視しながら待機
```

**確認事項：**

- タイムスロットが押せる状態になった瞬間にクリックされるか
- 予約フォームが正しく入力されるか
- 予約確定が成功するか

### 5.2 ログファイルの確認

```bash
# ログファイルを確認
cat logs/jicoo-bot.log

# または最新のログを確認
tail -f logs/jicoo-bot.log
```

---

## ステップ 6: 問題発生時のトラブルシューティング

### 6.1 よくある問題と解決策

| 問題                  | 原因                             | 解決策                                                             |
| --------------------- | -------------------------------- | ------------------------------------------------------------------ |
| ChromeDriver のエラー | ChromeDriver のバージョン不一致  | WebDriverManager が自動で対応します。Chrome ブラウザを最新版に更新 |
| 要素が見つからない    | セレクタが間違っている           | 開発者ツールで要素を確認し、セレクタを調整                         |
| タイムアウトエラー    | ページ読み込みが遅い             | `application.properties` の `webdriver.timeout.seconds` を増やす   |
| ログイン失敗          | ログイン情報が間違っている       | `application.properties` のログイン情報を確認                      |
| 予約が失敗する        | フォームのセレクタが間違っている | 開発者ツールでフォーム要素を確認し、セレクタを調整                 |

### 6.2 デバッグモードでの実行

ログレベルを `DEBUG` に変更して詳細なログを確認：

`logback.xml` を編集：

```xml
<root level="debug">
    <appender-ref ref="STDOUT" />
    <appender-ref ref="FILE" />
</root>
```

---

## ステップ 7: パフォーマンス調整

### 7.1 監視間隔の調整

`application.properties` で監視間隔を調整：

```properties
# より頻繁に監視する場合（例: 3秒）
jicoo.monitoring.interval.seconds=3

# 負荷を減らす場合（例: 10秒）
jicoo.monitoring.interval.seconds=10
```

### 7.2 待機時間の調整

`ReservationService.java` の `Thread.sleep()` の値を調整：

- ページ読み込み待機: 2000ms → 必要に応じて調整
- ログイン後待機: 3000ms → 必要に応じて調整
- 日付選択後待機: 2000ms → 必要に応じて調整

---

## ステップ 8: 本番運用の準備

### 8.1 ヘッドレスモードでの実行

テストが成功したら、ヘッドレスモードで実行：

`application.properties` を編集：

```properties
webdriver.headless=true
```

### 8.2 自動起動の設定（オプション）

Windows の場合、タスクスケジューラで自動起動を設定：

1. タスクスケジューラを開く
2. 基本タスクの作成
3. トリガー: 毎日 19:55
4. 操作: プログラムの開始
5. プログラム: `java.exe`
6. 引数: `-jar C:\path\to\jicoo-reservation-bot-1.0.0.jar`

---

## 📝 動作確認チェックリスト（最終確認）

- [ ] WebDriver が正常に初期化される
- [ ] すべての URL にアクセスできる
- [ ] ログインポップアップが正しく処理される
- [ ] カレンダーで 1 週間後の日付が選択される
- [ ] タイムスロット監視が正常に動作する
- [ ] タイムスロットボタンがクリックされる
- [ ] 予約フォームが正しく入力される
- [ ] 予約確定が成功する
- [ ] ログが正しく出力される
- [ ] GUI でログが表示される
- [ ] エラー発生時にリトライが動作する

---

**作成日**: 2025-11-18  
**バージョン**: 1.0.0
